import { Request, Response } from "express";
import { PDFService } from "../services/pdfService";
import fs from "fs";

// Define types for multer files
interface MulterRequest extends Request {
  files?: Express.Multer.File[];
  file?: Express.Multer.File;
}

export class PDFController {
  
  static async merge(req: Request, res: Response) {
    try {
      const files = (req as MulterRequest).files!;
      const filePaths = files.map(file => file.path);
      
      const mergedPDF = await PDFService.mergePDFs(filePaths);
      
      // Clean up temp files
      filePaths.forEach(filePath => {
        if (fs.existsSync(filePath)) fs.unlinkSync(filePath);
      });
      
      res.setHeader("Content-Type", "application/pdf");
      res.setHeader("Content-Disposition", "attachment; filename=merged.pdf");
      res.send(mergedPDF);
      
    } catch (error) {
      console.error("Merge error:", error);
      res.status(500).json({ error: "Failed to merge PDFs" });
    }
  }

  static async split(req: Request, res: Response) {
    try {
      const file = (req as MulterRequest).file!;
      const { pagesPerSplit = 1 } = req.body;
      
      const splitPDFs = await PDFService.splitPDF(file.path, parseInt(pagesPerSplit));
      
      // Clean up temp file
      if (fs.existsSync(file.path)) fs.unlinkSync(file.path);
      
      if (splitPDFs.length === 1) {
        res.setHeader("Content-Type", "application/pdf");
        res.setHeader("Content-Disposition", "attachment; filename=split.pdf");
        res.send(splitPDFs[0]);
      } else {
        // Send as zip in production
        res.json({
          message: `PDF split into ${splitPDFs.length} files`,
          files: splitPDFs.map((pdf, index) => ({
            data: pdf.toString("base64"),
            filename: `split-part-${index + 1}.pdf`
          }))
        });
      }
      
    } catch (error) {
      console.error("Split error:", error);
      res.status(500).json({ error: "Failed to split PDF" });
    }
  }

  static async compress(req: Request, res: Response) {
    try {
      const file = (req as MulterRequest).file!;
      const compressedPDF = await PDFService.compressPDF(file.path);
      
      // Clean up temp file
      if (fs.existsSync(file.path)) fs.unlinkSync(file.path);
      
      res.setHeader("Content-Type", "application/pdf");
      res.setHeader("Content-Disposition", "attachment; filename=compressed.pdf");
      res.send(compressedPDF);
      
    } catch (error) {
      console.error("Compress error:", error);
      res.status(500).json({ error: "Failed to compress PDF" });
    }
  }

    static async getInfo(req: Request, res: Response) {
    try {
      const file = (req as MulterRequest).file!;
      const info = await PDFService.getPDFInfo(file.path);
      
      // Clean up temp file
      if (fs.existsSync(file.path)) fs.unlinkSync(file.path);
      
      res.json({
        ...info,
        message: "Basic PDF info extracted. Install pdf-parse for detailed text extraction."
      });
      
    } catch (error) {
      console.error("Info error:", error);
      res.status(500).json({ error: "Failed to get PDF info" });
    }
  } catch (error) {
      console.error("Info error:", error);
      res.status(500).json({ error: "Failed to get PDF info" });
    }
  }
}

